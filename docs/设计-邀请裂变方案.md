# 邀请裂变方案（完整设计）

**文档版本**：1.2  
**产品**：疯狂农场价格计算器（fknc.top）  
**目标**：邀请码 + 被邀请人**首次充值会员**后，邀请人获得会员奖励（拉新且拉充值）  
**约束**：与现有版本完全兼容，不破坏已有登录、会员、激活码、免费次数逻辑  
**状态**：方案设计，暂不落代码

---

## 一、目标与规则

### 1.1 业务规则

| 项目 | 说明 |
|------|------|
| **邀请人** | 已登录用户，拥有唯一 6 位邀请码；通过「邀请有礼」弹窗分享邀请码给他人。 |
| **被邀请人** | 注册时**可选填写**邀请人的邀请码以建立邀请关系（仅建立关系，此时不发奖）。采用填写邀请码方式，不使用 URL 参数 ref，避免与现有 crop/s 等参数混杂。 |
| **有效邀请（发奖条件）** | 被邀请人**首次充值会员**（即首次使用激活码成功开通/续费）时，才给邀请人发奖；只注册不充值不发奖。 |
| **奖励** | **低一档**：被邀请人首次充值档位对应邀请人获得下一档会员；**被邀请人充日卡时，邀请人不获得奖励**。详见下表格。 |
| **被邀请人** | 不强制给被邀请人额外奖励；若后续希望「新用户礼包」可在此方案上扩展。 |

### 1.2 奖励档位：低一档（被邀请人充日卡不送）

按「被邀请人本次首次充值对应的档位」降一档送给邀请人；**被邀请人充日卡时，邀请人不获得任何奖励**（0 天）。充值档位仅支持固定天数 1/7/30/90/365/1095，暂不考虑其他天数。映射表如下：

| 被邀请人充值档位 | 被邀请人获得天数 | 邀请人获得 |
|------------------|------------------|------------|
| 日卡 | 1 天 | **不送（0 天）** |
| 周卡 | 7 天 | 1 天（日卡） |
| 月卡 | 30 天 | 7 天（周卡） |
| 季卡 | 90 天 | 30 天（月卡） |
| 年卡 | 365 天 | 90 天（季卡） |
| 三年 | 1095 天 | 365 天（年卡） |

- 激活码 payload 中 days 仅可能为 1/7/30/90/365/1095，对应上表档位；日卡（1 天）对应邀请人 0 天，不写 `user_subscriptions`、仅更新 `invite_records.reward_claimed_at` 表示已处理。

### 1.3 与现有能力的关系

- **会员与订阅**：沿用现有 `user_subscriptions`（user_id、subscription_end_at）及 `get_my_subscription`、续费/激活逻辑；邀请奖励相当于「系统为邀请人增加若干天」的续费，复用同一套到期时间顺延规则。
- **激活码**：不变。购买获得的激活码仍通过 Edge Function `activate-subscription` 验签写入；**发奖时机**为被邀请人**首次**激活成功后，在同一流程内（或紧随其后）根据邀请关系为邀请人加对应天数。
- **免费次数**：不变。未开通会员时的每日 1 次逻辑不改。
- **登录/注册**：沿用 Supabase Auth；注册时若用户**填写了邀请码**，在注册成功并登录后调用「绑定邀请关系」，仅写入 invite_records（reward_claimed_at 为 NULL），**不在此刻发奖**；发奖发生在被邀请人首次充值成功时。

---

## 二、兼容性说明

### 2.1 老用户与老流程

- **已有用户**：从未参与邀请功能的用户，**懒生成**邀请码——首次打开「邀请有礼」弹窗或首次调用「获取或生成我的邀请码」时再生成并落库，不预先批量生成。
- **未填邀请码的注册**：新用户注册时不填邀请码，流程与现在完全一致，不写邀请关系、不发奖。
- **已有 RPC/Edge Function**：`get_my_subscription`、`use_free_query` 不变。`activate-subscription` 的**入参、出参、对调用方契约**不变；可在其**内部**在「激活成功写库后」增加一步：查 invite_records 中当前用户（被邀请人）是否为某条记录的 invitee_id 且 reward_claimed_at 为 NULL，若是则按本次充值天数（或档位）为对应 inviter_id 加相应天数并更新 reward_claimed_at（推荐在同一 Edge Function 内完成，保证一致性）。

### 2.2 数据与接口

- 仅**新增**表与**新增**接口，不删除、不修改现有表结构（如 `user_subscriptions`、`used_activation_codes`）。
- 前端：未填写邀请码的注册、未打开邀请弹窗时，行为与当前版本一致。

---

## 三、数据模型

### 3.1 新增表

以下为 Supabase/PostgreSQL 下的表名与字段定义。

**（1）用户邀请码表 `user_invite_codes`**

| 字段 | 类型 | 说明 |
|------|------|------|
| user_id | uuid, PK, FK → auth.users | 用户 ID，与 Supabase Auth 一致。 |
| invite_code | text, UNIQUE, NOT NULL | 该用户的唯一邀请码，**6 位**，全局唯一，保证用户间绝不重复。 |
| created_at | timestamptz | 创建时间。 |

- 约束：一个 user_id 对应一个 invite_code；invite_code 全局 UNIQUE，生成时若冲突则重试直至成功。
- 用途：通过邀请码反查邀请人；用户将邀请码分享给他人填写。

**（2）邀请记录表 `invite_records`**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid, PK, default gen_random_uuid() | 主键。 |
| inviter_id | uuid, NOT NULL, FK → auth.users | 邀请人 user_id。 |
| invitee_id | uuid, NOT NULL, FK → auth.users | 被邀请人 user_id。 |
| invite_code | text, NOT NULL | 当时使用的邀请码（冗余，便于排查与统计）。 |
| reward_claimed_at | timestamptz, NULL | 邀请人奖励发放时间；NULL 表示被邀请人尚未首次充值、尚未发奖。 |
| invitee_recharge_days | integer, NULL | 被邀请人首次充值增加的天数；发奖时写入，用于审计与统计。 |
| created_at | timestamptz | 记录创建时间（绑定邀请关系的时间，即注册时）。 |

- 约束：唯一约束 (invitee_id)——每个被邀请人仅能作为「被邀请人」出现一次，即每个新用户最多触发一次邀请发奖（防止同一人多次换号刷奖励）。
- 用途：注册时若填写邀请码则写入邀请关系（reward_claimed_at 为 NULL）；被邀请人**首次充值**成功后，在 activate-subscription 流程内查此表、计算邀请人应得天数、发奖并更新 reward_claimed_at 与 invitee_recharge_days。

### 3.2 不修改的现有表

- `user_subscriptions`：仅通过「邀请奖励」逻辑写入/更新 subscription_end_at（与现有续费同一字段、同一顺延规则）。
- `auth.users`、`used_activation_codes` 等：不改结构、不删字段。

### 3.3 邀请码格式与生成

- **格式**：**6 位**，字符集为数字+大写字母（建议排除易混字符如 0/O、1/I），保证**全局唯一、用户间绝不重复**。
- **生成时机**：**懒生成**——用户首次打开「邀请有礼」弹窗或首次调用「获取或生成我的邀请码」时，若表内尚无该 user_id 记录，则生成 6 位码并插入 `user_invite_codes`；若已存在则直接返回。
- **唯一性**：表级 UNIQUE(invite_code)；生成时若与已有码冲突则重新生成再插入，直至成功，确保不重复。

---

## 四、流程说明

### 4.1 邀请人侧

1. **入口与弹窗**
   - **入口**：**选择作物页面**上某一位置 **fix 固定图标**（如悬浮按钮），不放在 Footer（Footer 内容已较多）。用户点击该图标打开「邀请有礼」弹窗。
   - **首次进入**：用户**第一次进入选择作物页面**（已登录）时，**直接自动弹出**「邀请有礼」弹窗；用户关闭后，之后可通过 fix 图标再次打开。
   - **弹窗内容**：同一弹窗内展示「我的邀请码」与「复制邀请码」、以及**邀请统计**（已邀请 X 人、已获得 X 天奖励等），即邀请与统计在同一弹窗内。

2. **获取邀请码与展示**
   - 打开弹窗时调用后端「获取或生成我的邀请码」接口；若表内无则懒生成并写入 `user_invite_codes`，返回 6 位 invite_code。
   - 展示邀请码、提供「复制邀请码」；并调用「我的邀请统计」展示已邀请人数、已获得奖励天数。

3. **免费次数用尽时的提醒**
   - 当用户免费次数用尽、弹窗引导开通会员时，**同时提醒**可「邀请好友充值，你得会员」（如文案+入口跳转或打开邀请有礼弹窗），与现有会员引导并列或补充。

### 4.2 被邀请人侧（新用户）

1. **注册时填写邀请码（不使用 URL ref）**
   - 采用**填写邀请码**方式建立邀请关系，**不使用** URL 参数 ref，避免与现有 crop、s 等链接参数混杂、难以管理。
   - 在**注册页**（或注册流程中）提供**选填**「邀请码」输入框；用户若从邀请人处获得 6 位邀请码，可在此填写。

2. **注册与绑定**
   - 用户按现有流程完成邮箱验证码注册（Supabase Auth signUp）。
   - 注册成功并登录后，若用户**填写了邀请码**：
     - 调用后端「绑定邀请关系」接口，传入该邀请码；**此处仅建立邀请关系，不发奖**；
     - 后端校验邀请码有效、inviter ≠ 当前用户、当前用户尚未作为 invitee 存在于 invite_records 后，写入 `invite_records`（inviter_id、invitee_id、invite_code），reward_claimed_at 保持 NULL。
   - 若未填写邀请码：不调用绑定接口，不写 `invite_records`。

### 4.3 发奖逻辑（后端）

- **触发时机**：被邀请人**首次使用激活码成功充值**时，在 `activate-subscription` Edge Function 内（为当前用户写完 `user_subscriptions` 与 `used_activation_codes` 之后）执行。
- **触发条件**：当前用户（激活码使用者）在 `invite_records` 中存在一条记录且该条 `reward_claimed_at` 为 NULL（即尚未因该被邀请人发过奖）；且 inviter_id ≠ 当前用户（不能自己邀自己）。
- **奖励内容（低一档）**：根据本次充值天数（仅 1/7/30/90/365/1095）映射到档位，再按 1.2 表格得到邀请人应得天数：
  - 若邀请人应得 0 天（被邀请人充的是日卡）：不更新 `user_subscriptions`，仅将本条 `invite_records.reward_claimed_at` 设为当前时间，并写入 `invitee_recharge_days`（本次天数），表示已处理、不再重复发奖。
  - 若邀请人应得 ≥1 天：为 inviter_id 在 `user_subscriptions` 上增加对应天数；顺延规则与现有续费一致（未过期则在到期日顺延，已过期则从 now() 起算）；然后将本条 `invite_records.reward_claimed_at` 设为当前时间、`invitee_recharge_days` 设为本次被邀请人充值天数。
- **幂等**：同一 invite_records 只发奖一次，以 reward_claimed_at 非空为已处理依据。

### 4.4 防刷与边界

- **每人仅能作为被邀请人一次**：`invite_records.invitee_id` 唯一，同一用户多次用不同邀请码注册也只记第一条，只给第一个邀请人发奖。
- **自己不能邀请自己**：校验 inviter_id ≠ invitee_id。
- **邀请码有效**：仅接受存在于 `user_invite_codes` 中的 code，且 inviter 存在。
- **邀请码长期有效**：用户填写的邀请码在注册时绑定即可，不做有效期限制。
- **发奖幂等**：以 `reward_claimed_at` 是否为空判断是否已对该条邀请记录发奖；已发奖则不再处理。

---

## 五、接口与职责划分（方案级）

### 5.1 建议新增接口（RPC 或 Edge Function）

| 接口 | 职责 | 说明 |
|------|------|------|
| 获取或生成我的邀请码 | 入参：无（以 auth.uid() 为准）；出参：invite_code（6 位）。 | 若无则懒生成并写入 `user_invite_codes`（保证唯一），若有则直接返回。需 RLS 或 security definer 仅允许当前用户访问自己的 code。 |
| 绑定邀请关系 | 入参：invite_code；上下文：auth.uid() 为当前登录用户（被邀请人）。 | 校验 code 存在于 user_invite_codes、inviter ≠ invitee、invitee 在 invite_records 中不存在；插入 invite_records，**不发奖**（reward_claimed_at 保持 NULL）。建议在单事务中完成。 |
| 邀请奖励（内部） | 在 activate-subscription 内调用，不对外暴露。 | 被邀请人首次激活成功后，按本次充值档位（1/7/30/90/365/1095）查「低一档」表，为 inviter 加对应天数并写入 invitee_recharge_days；日卡 0 天则只更新 reward_claimed_at。 |
| 我的邀请统计 | 入参：无；出参：已邀请人数、已获得奖励天数等。 | 基于 `invite_records` 统计 inviter_id = auth.uid() 且 reward_claimed_at 非空的条数；**与邀请有礼弹窗同屏展示**。 |

### 5.2 不修改的现有接口

- `get_my_subscription`：不变。
- `use_free_query`：不变。
- `activate-subscription`（Edge Function）：对外入参/出参不变；**内部**在激活成功写库后增加「邀请奖励」逻辑：若当前用户是被邀请人且尚未发奖，则按低一档为邀请人加天数（日卡不送）。

### 5.3 前端职责（方案级）

- **选择作物页**：fix 图标入口；首次进入该页时自动弹出「邀请有礼」弹窗，关闭后可从 fix 图标再次打开；弹窗内展示邀请码（复制）、我的邀请统计（已邀请人数、已获得奖励天数）。
- **免费次数用尽弹窗**：在现有开通会员引导基础上，增加「邀请好友充值，你得会员」类提醒（可打开邀请有礼弹窗或文案链接）。
- **注册页**：提供选填「邀请码」输入框；注册成功并登录后，若填写了邀请码则调用「绑定邀请关系」，仅建立关系不发奖。
- 未填邀请码的注册：与现有一致，不调用邀请相关接口。

---

## 六、与 PRD 的衔接

- 在 **PRD 功能总览** 中可新增一行：**邀请有礼** | 选择页 fix 入口+首次弹窗、邀请码填写注册、被邀请人首次充值后邀请人得低一档会员（日卡不送） | 是（需登录）。
- 在 **数据与依赖** 中可新增：邀请码表、邀请记录表；新增 RPC（获取/生成邀请码、绑定邀请关系、我的邀请统计）与 activate-subscription 内邀请奖励逻辑。
- 术语表可增加：**有效邀请（发奖）** = 被邀请人注册时填写邀请码并首次充值会员；**邀请人** = 提供 6 位邀请码的已登录用户；**低一档** = 被邀请人充周卡送日卡、充月卡送周卡等，充日卡不送。

---

## 七、实现顺序建议（供后续开发参考）

1. **库表与策略**：创建 `user_invite_codes`（6 位 invite_code 唯一）、`invite_records`（含 invitee_recharge_days）及 RLS（仅本人可读自己的邀请码、邀请记录统计）。
2. **后端**：实现「获取或生成我的邀请码」（6 位、懒生成、保证唯一）「绑定邀请关系」「我的邀请统计」；在 activate-subscription 内增加「被邀请人首次激活成功时按低一档为邀请人加天数、写 invitee_recharge_days」逻辑（日卡不送则只更新 reward_claimed_at）。
3. **前端**：选择作物页 fix 图标 + 首次进入自动弹出邀请有礼弹窗，弹窗内邀请码+统计；注册页选填邀请码、注册成功后调用「绑定邀请关系」；免费次数用尽时增加邀请提醒。
4. **测试与上线**：覆盖「未填邀请码注册」「填写邀请码注册」「同一被邀请人仅发奖一次」「自己不能邀请自己」「6 位码唯一」「首次进入弹窗与 fix 打开」等；确认老用户、老流程无回归。

---

## 八、总结

| 项目 | 说明 |
|------|------|
| 奖励 | **低一档**：被邀请人首次充值后，邀请人按档位得下一档会员（周→日、月→周、季→月、年→季、三年→年）；**被邀请人充日卡时邀请人不获得奖励**。 |
| 兼容 | 不改现有表结构、不改现有 RPC/EF 对外契约；仅新增表与新增接口，activate-subscription 内增加邀请奖励逻辑；老用户懒生成邀请码，未填邀请码注册行为不变。 |
| 数据 | 新增 `user_invite_codes`、`invite_records`；发奖时写 `user_subscriptions`（日卡不送则不写、仅更新 reward_claimed_at）。 |
| 防刷 | 每用户仅能作为被邀请人一次、不能自邀、邀请码有效、每条邀请记录只发奖一次。 |

本方案仅做设计与约定，具体建表语句、RPC/Edge Function 实现与前端改动可在开发阶段按此文档落地，并保持与现有版本兼容。

---

## 九、方案与现有实现审查（待实现前注意）

以下为对当前方案与已有代码的对照审查，用于实现时避免遗漏与冲突。

### 9.1 与现有实现一致、无需改动的部分

- **会员与激活码**：`user_subscriptions`、`used_activation_codes`、`get_my_subscription`、`activate-subscription` 的入参/出参、前端 `activateSubscriptionWithCode` 调用方式均不变；仅在后端激活成功后**内部**增加邀请奖励一步。
- **登录/注册**：现有为「邮箱 + 验证码 + 密码」注册（`sendEmailOtp` → `verifyEmailOtp(email, token, password)`），注册成功后有 session 并回调 `onLoginSuccess()`。邀请码只需在**注册表单**增加选填「邀请码」输入框，在 `verifyEmailOtp` 成功并拿到 session 后，若填写了邀请码则调用「绑定邀请关系」即可；**登录**（非注册）可不展示邀请码输入框。
- **免费次数与会员**：`use_free_query`、选择页/计算器进入逻辑、会员弹窗（Footer）不变；仅增加「免费次数用尽」弹窗内的邀请提醒与邀请有礼弹窗的打开入口。

### 9.2 需在实现时明确或补充的点

**（1）激活码 days 非固定档位时的邀请奖励**

- 现状：Edge Function 仅校验 `payload.days >= 1`（且 `Math.floor`），生成脚本 `generate-activation-code.cjs` 可传入任意天数；批量脚本为 7/30/90/365 等固定档位。
- 约定：方案约定充值档位仅 1/7/30/90/365/1095。实现时建议：**邀请奖励**仅当 `days ∈ {1,7,30,90,365,1095}` 时按低一档表给邀请人加天数；若为其他天数（如 2、15），仍正常为当前用户开通/续费，但对邀请人**不发天数**（邀请人得 0 天），同时仍将本条 `invite_records.reward_claimed_at`、`invitee_recharge_days` 更新，避免重复处理。这样与「暂不考虑其他天数」一致，且不会因异常码导致重复发奖。

**（2）「首次进入选择作物页」弹窗的标记**

- 方案要求：用户**第一次进入选择作物页面**时自动弹出邀请有礼弹窗，关闭后仅能通过 fix 图标再打开。
- 实现建议：用 **localStorage** 存一个标记（如 `invite_modal_first_shown`），在已登录且 `currentPage === 'selector'` 时，若未标记则弹窗并设标记；若希望「按用户」而非「按设备」只弹一次，可改为调用后端「是否已展示过邀请弹窗」接口（需新增字段或表），首版用 localStorage 即可。

**（3）绑定邀请关系的时机与错误提示**

- 注册成功（`verifyEmailOtp` 成功）后立即调用「绑定邀请关系」；若该用户已在 `invite_records` 中作为 invitee 存在（唯一约束），后端应返回明确错误（如 `already_bound`），前端提示「您已经绑定过邀请关系」等，避免用户困惑。

**（4）邀请统计「已获得奖励天数」的计算**

- `invite_records` 存的是 `invitee_recharge_days`（被邀请人充值天数）。「已获得 X 天奖励」应为邀请人实际获得的低一档天数之和。实现方式二选一：  
  - **推荐**：在「我的邀请统计」RPC 中，对每条 `reward_claimed_at` 非空记录，用 `invitee_recharge_days` 查低一档表得到该条邀请人获得的天数，再求和；  
  - 或发奖时在 `invite_records` 增加一列 `inviter_reward_days` 写入，统计时直接 sum。  
方案未强制要求新增列，用 RPC 内按档位换算即可。

**（5）选择作物页与 fix 图标、弹窗状态归属**

- 现状：选择作物页为 `App.tsx` 内 `page-selector`，内含 `CropSelector` + `Footer`；弹窗状态（如 `showSubscriptionModal`）在 App 层。
- 实现建议：邀请有礼弹窗状态（如 `showInviteModal`）也放在 **App**，与 `showSubscriptionModal` 一致；fix 图标可放在 `page-selector` 内与 CropSelector、Footer 同级，点击打开 `showInviteModal`；首次进入 selector 的 effect 在 App 中判断「已登录且当前为 selector 且未标记已展示」则 `setShowInviteModal(true)` 并写 localStorage。

**（6）免费次数用尽弹窗的邀请入口**

- 现状：`showPaywallModal` 内仅有「开通会员」按钮，点击关闭 paywall 并打开会员弹窗。
- 实现：在现有文案与按钮下方或并列增加一句「邀请好友充值，你得会员」及按钮/链接，点击后关闭 paywall（可选）并打开邀请有礼弹窗（需将 `setShowInviteModal` 暴露给该 Modal 或通过 App 状态统一打开）。

### 9.3 与现有代码的衔接清单

| 项目 | 现有 | 邀请方案需做 |
|------|------|--------------|
| 注册页 | Login.tsx：isSignUp 时邮箱+验证码+密码+确认密码 | 仅在 isSignUp 时增加选填「邀请码」；verifyEmailOtp 成功后若邀请码非空则调「绑定邀请关系」 |
| 选择页 | CropSelector + Footer，无 fix、无邀请弹窗 | 增加 fix 图标、邀请有礼弹窗（内容：邀请码+复制+我的邀请统计）；首次进入 selector 自动弹窗（localStorage 标记） |
| 免费次数用尽 | App 内 Modal，仅「开通会员」 | 增加「邀请好友充值，你得会员」入口，可打开邀请有礼弹窗 |
| activate-subscription | 验签、写 user_subscriptions、used_activation_codes 后 return | 在写库成功后、return 前：查 invite_records（invitee_id=当前用户且 reward_claimed_at 为 NULL），若存在且 inviter_id≠当前用户则按 days 低一档给 inviter 加天数、更新 reward_claimed_at 与 invitee_recharge_days（days 非 1/7/30/90/365/1095 时邀请人得 0 天仍要更新记录） |
| Supabase | 无 user_invite_codes、invite_records、无相关 RPC | 新建两表、RLS；新增 RPC：获取/生成邀请码、绑定邀请关系、我的邀请统计 |
| 前端 supabase.ts | 无邀请相关 API | 新增 getOrCreateInviteCode、bindInvite、getMyInviteStats（或等价命名） |

### 9.4 小结

- 方案与现有登录、会员、激活码、免费次数流程兼容；未发现不可实现的冲突。
- 实现前需落实：非标准 days 的邀请奖励按 0 天处理并仍更新记录、首次弹窗标记方式、绑定失败提示、邀请统计按档位换算天数、fix 与弹窗状态在 App 层、paywall 内增加邀请入口。
- 开发顺序建议：先建表与 RPC（含绑定、统计、获取/生成邀请码）→ 再改 Edge Function 发奖 → 最后前端（注册页邀请码、选择页 fix+弹窗+首次弹窗、paywall 邀请入口）。
