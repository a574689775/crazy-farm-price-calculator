# ==============================================
# 疯狂农场价格计算器 - https://www.fknc.top
# 所有 bdstatic 图片统一走 /carzyfarm/ 代理，同域后可被 SW 缓存
# ==============================================

# HTTP → HTTPS www
server {
    listen 80;
    listen [::]:80;
    server_name fknc.top www.fknc.top;
    return 301 https://www.fknc.top$request_uri;
}

# HTTPS fknc.top（非 www）→ www
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name fknc.top;
    ssl_certificate /etc/nginx/fknc.top.pem;
    ssl_certificate_key /etc/nginx/fknc.top.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    return 301 https://www.fknc.top$request_uri;
}

# 主站：www.fknc.top
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name www.fknc.top;

    ssl_certificate /etc/nginx/fknc.top.pem;
    ssl_certificate_key /etc/nginx/fknc.top.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    root /var/www/crazy-farm;
    index index.html;

    # 统一代理：头像、背景、作物图、favicon 等所有 bdstatic 图片
    location ^~ /carzyfarm/ {
        proxy_pass https://now.bdstatic.com/stash/v1/5249c21/soundMyst/0ca7f11/carzyfarm/;
        proxy_ssl_server_name on;
        proxy_set_header Host now.bdstatic.com;
    }

    location = /sw.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json;
}
