<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>生成激活码（本地）</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 560px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    p { color: #666; font-size: 14px; margin: 0 0 1rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.35rem; }
    textarea, input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    textarea { min-height: 140px; resize: vertical; font-family: monospace; }
    .row { margin-bottom: 1rem; }
    button { padding: 10px 20px; background: #843100; color: #fff; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .days-row { display: flex; flex-direction: column; gap: 0.5rem; }
    .quick-days { display: flex; gap: 8px; flex-wrap: wrap; }
    .quick-btn { padding: 6px 14px; background: #e8d5c4; color: #5c3317; border: 1px solid #c9a86c; border-radius: 6px; font-size: 13px; cursor: pointer; }
    .quick-btn:hover { background: #ddc9b4; }
    .out-wrap { margin-top: 1rem; }
    .out { padding: 12px; background: #f5f5f5; border-radius: 8px 8px 0 0; word-break: break-all; font-family: monospace; font-size: 13px; white-space: pre-wrap; }
    .out.err { border-radius: 8px; }
    .copy-btn { width: 100%; padding: 10px; background: #843100; color: #fff; border: none; border-radius: 0 0 8px 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .copy-btn:hover { background: #6b2700; }
    .copy-btn.copied { background: #2d7d46; }
    .err { color: #c41e3a; }
    .priv-actions { margin-top: 6px; font-size: 13px; }
    .link-btn { background: none; border: none; color: #843100; cursor: pointer; padding: 0; text-decoration: underline; font-size: 13px; }
    .link-btn:hover { color: #6b2700; }
    .priv-sep { color: #999; margin: 0 6px; font-size: 12px; }
    .hint { font-size: 12px; color: #999; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <h1>生成激活码（本地）</h1>
  <p>私钥和生成过程仅在你本机完成，不会上传到任何服务器。请妥善保管私钥。</p>
  <div class="row">
    <label for="priv">私钥（PEM，含 -----BEGIN PRIVATE KEY-----）</label>
    <textarea id="priv" placeholder="粘贴 Ed25519 私钥 PEM..."></textarea>
    <div class="priv-actions">
      <button type="button" id="savePrivBtn" class="link-btn">保存私钥到本机</button>
      <span class="priv-sep">|</span>
      <button type="button" id="clearPrivBtn" class="link-btn">清除已保存的私钥</button>
    </div>
    <div class="hint">由 scripts/generate-keypair.cjs 生成。保存后下次打开将自动填充，仅存于本机 localStorage。</div>
  </div>
  <div class="row">
    <label for="days">有效天数</label>
    <div class="days-row">
      <input type="number" id="days" min="1" max="3660" value="7" />
      <div class="quick-days">
        <button type="button" class="quick-btn" data-days="7">周卡（7 天）</button>
        <button type="button" class="quick-btn" data-days="30">月卡（30 天）</button>
        <button type="button" class="quick-btn" data-days="90">季卡（90 天）</button>
        <button type="button" class="quick-btn" data-days="365">年卡（365 天）</button>
      </div>
    </div>
    <div class="hint">可填具体天数，或点上方快捷选项。</div>
  </div>
  <button type="button" id="btn">生成激活码</button>
  <div id="outWrap" class="out-wrap" style="display:none;">
    <div id="out" class="out"></div>
    <button type="button" id="copyBtn" class="copy-btn">复制激活码</button>
  </div>

  <script>
    const PRIV_STORAGE_KEY = 'crazy-farm-activation-private-key'

    try {
      const saved = localStorage.getItem(PRIV_STORAGE_KEY)
      if (saved) document.getElementById('priv').value = saved
    } catch (e) {}

    document.getElementById('savePrivBtn').addEventListener('click', function () {
      const pem = (document.getElementById('priv').value || '').trim()
      if (!pem || pem.indexOf('BEGIN PRIVATE KEY') === -1) {
        alert('请先粘贴完整的私钥后再保存')
        return
      }
      try {
        localStorage.setItem(PRIV_STORAGE_KEY, pem)
        alert('已保存到本机，下次打开将自动填充')
      } catch (e) {
        alert('保存失败：' + (e.message || '可能处于无痕模式或存储已满'))
      }
    })

    document.getElementById('clearPrivBtn').addEventListener('click', function () {
      try {
        localStorage.removeItem(PRIV_STORAGE_KEY)
        document.getElementById('priv').value = ''
        alert('已清除')
      } catch (e) {}
    })

    function base64url(buffer) {
      const bytes = new Uint8Array(buffer)
      let binary = ''
      for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i])
      return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '')
    }

    function pemToBinary(pem) {
      const lines = pem.trim().split(/\r?\n/)
      const base64 = lines
        .filter(function (line) {
          return line && !line.startsWith('-----')
        })
        .join('')
      const binary = atob(base64)
      const buf = new Uint8Array(binary.length)
      for (let i = 0; i < binary.length; i++) buf[i] = binary.charCodeAt(i)
      return buf.buffer
    }

    let lastCode = ''

    document.querySelectorAll('.quick-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        document.getElementById('days').value = btn.getAttribute('data-days')
      })
    })

    document.getElementById('btn').addEventListener('click', async function () {
      const privEl = document.getElementById('priv')
      const daysEl = document.getElementById('days')
      const outEl = document.getElementById('out')
      const outWrap = document.getElementById('outWrap')
      const copyBtn = document.getElementById('copyBtn')
      let pem = (privEl.value || '').trim()
      pem = pem.replace(/\\n/g, '\n')
      const days = parseInt(daysEl.value, 10) || 7
      if (!pem || !pem.includes('BEGIN PRIVATE KEY')) {
        outWrap.style.display = 'block'
        copyBtn.style.display = 'none'
        outEl.className = 'out err'
        outEl.textContent = '请粘贴完整的私钥 PEM（含 -----BEGIN PRIVATE KEY-----）'
        return
      }
      if (days < 1 || days > 3660) {
        outWrap.style.display = 'block'
        copyBtn.style.display = 'none'
        outEl.className = 'out err'
        outEl.textContent = '有效天数请填 1～3660'
        return
      }
      try {
        const keyData = pemToBinary(pem)
        const key = await crypto.subtle.importKey(
          'pkcs8',
          keyData,
          { name: 'Ed25519' },
          false,
          ['sign']
        )
        const payload = JSON.stringify({ days: days, v: 2 })
        const payloadBytes = new TextEncoder().encode(payload)
        const sig = await crypto.subtle.sign('Ed25519', key, payloadBytes)
        const code = 'CF-' + base64url(payloadBytes) + '.' + base64url(sig)
        lastCode = code
        outWrap.style.display = 'block'
        copyBtn.style.display = 'block'
        outEl.className = 'out'
        outEl.textContent = code + '\n\n会员天数：' + days + ' 天（按激活起算）'
      } catch (e) {
        outWrap.style.display = 'block'
        copyBtn.style.display = 'none'
        outEl.className = 'out err'
        outEl.textContent = '生成失败：' + (e.message || String(e))
      }
    })

    document.getElementById('copyBtn').addEventListener('click', function () {
      if (!lastCode) return
      navigator.clipboard.writeText(lastCode).then(function () {
        const btn = document.getElementById('copyBtn')
        btn.textContent = '已复制'
        btn.classList.add('copied')
        setTimeout(function () {
          btn.textContent = '复制激活码'
          btn.classList.remove('copied')
        }, 1500)
      }).catch(function () {
        alert('复制失败，请手动选择上方激活码复制')
      })
    })
  </script>
</body>
</html>
